name: Deploy TaskMap

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:ci

      - name: Build application
        run: npm run build

      - name: Deploy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          # Copy full build output (including nested assets/).
          # Use strip_components to drop the leading "dist/" on the remote.
          source: "dist/**"
          target: "/var/www/task.kanazawa-application-support.jp"
          strip_components: 1
          rm: true

      - name: Copy Nginx config to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "nginx-task.conf"
          # scp-action's `target` is a directory on the remote.
          target: "/tmp"

      - name: Setup Docker container and Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e

            echo "Step 0: Detect frontend container"
            CONTAINER="$(docker ps --format '{{.Names}}' | grep -E '^poster-mapping-deploy-frontend' | head -n 1 || true)"
            if [ -z "$CONTAINER" ]; then
              echo "ERROR: poster-mapping-deploy-frontend container not found."
              echo "Currently running containers:"
              docker ps -a
              exit 1
            fi
            echo "Using container: $CONTAINER"

            echo "Step 1: Create directory in Docker container"
            docker exec "$CONTAINER" mkdir -p /var/www/task.kanazawa-application-support.jp

            echo "Step 2: Copy TaskMap files to Docker container"
            docker cp /var/www/task.kanazawa-application-support.jp/. "$CONTAINER":/var/www/task.kanazawa-application-support.jp/

            echo "Step 3: Copy Nginx config to Docker container"
            docker cp /tmp/nginx-task.conf "$CONTAINER":/etc/nginx/conf.d/00-task.kanazawa-application-support.jp.conf

            echo "Step 4: Disable default.conf if exists"
            docker exec "$CONTAINER" sh -c 'if [ -f /etc/nginx/conf.d/default.conf ]; then mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled 2>/dev/null || true; fi'

            echo "Step 5: Test Nginx configuration"
            docker exec "$CONTAINER" nginx -t

            echo "Step 6: Reload Nginx"
            docker exec "$CONTAINER" nginx -s reload

            echo "Step 7: Verify deployment"
            echo "Files in container:"
            docker exec "$CONTAINER" ls -la /var/www/task.kanazawa-application-support.jp/ | head -5

            echo "Index.html first 3 lines:"
            docker exec "$CONTAINER" head -3 /var/www/task.kanazawa-application-support.jp/index.html

            echo "Assets directory (should exist):"
            docker exec "$CONTAINER" sh -c 'if [ -d /var/www/task.kanazawa-application-support.jp/assets ]; then ls -la /var/www/task.kanazawa-application-support.jp/assets | head -5; else echo "MISSING: /var/www/task.kanazawa-application-support.jp/assets"; fi'

            echo "Index.html title (should be Task Map):"
            docker exec "$CONTAINER" sh -c 'grep -n "<title>" /var/www/task.kanazawa-application-support.jp/index.html | head -3 || true'

            echo "Nginx config check:"
            docker exec "$CONTAINER" nginx -T 2>&1 | grep -A 5 "server_name task.kanazawa-application-support.jp" | head -10

            echo "Deployment completed successfully!"
