name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm run test:ci
      
      - name: Build
        run: npm run build
      
      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "dist/*"
          target: "/var/www/task.kanazawa-application-support.jp"
          strip_components: 1
          rm: true  # 既存ファイルを削除してからアップロード
      
      - name: Copy files to Docker container and reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e
            echo "=== Checking host directory ==="
            ls -la /var/www/task.kanazawa-application-support.jp/ | head -10
            
            echo "=== Ensuring container directory exists ==="
            docker exec poster-mapping-deploy-frontend-1 mkdir -p /var/www/task.kanazawa-application-support.jp
            
            echo "=== Copying files to container ==="
            docker cp /var/www/task.kanazawa-application-support.jp/. poster-mapping-deploy-frontend-1:/var/www/task.kanazawa-application-support.jp/
            
            echo "=== Verifying files in container ==="
            docker exec poster-mapping-deploy-frontend-1 ls -la /var/www/task.kanazawa-application-support.jp/ | head -10
            
            echo "=== Checking index.html in container ==="
            docker exec poster-mapping-deploy-frontend-1 cat /var/www/task.kanazawa-application-support.jp/index.html | head -5
            
            echo "=== Checking Nginx configuration ==="
            docker exec poster-mapping-deploy-frontend-1 nginx -t
            
            echo "=== Checking current Nginx config file ==="
            docker exec poster-mapping-deploy-frontend-1 cat /etc/nginx/conf.d/00-task.kanazawa-application-support.jp.conf
            
            echo "=== Checking if root directive exists in HTTPS server block ==="
            ROOT_EXISTS=$(docker exec poster-mapping-deploy-frontend-1 grep -c "root /var/www/task.kanazawa-application-support.jp" /etc/nginx/conf.d/00-task.kanazawa-application-support.jp.conf || echo "0")
            if [ "$ROOT_EXISTS" = "0" ]; then
              echo "WARNING: root directive not found! Fixing Nginx config..."
              # HTTPS serverブロックにrootディレクティブを追加
              docker exec poster-mapping-deploy-frontend-1 sh -c 'cat > /tmp/nginx_fix.conf << "EOF"
server {
    listen 80;
    server_name task.kanazawa-application-support.jp;
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
        access_log off;
    }
    
    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name task.kanazawa-application-support.jp;
    
    ssl_certificate /etc/letsencrypt/live/task.kanazawa-application-support.jp/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/task.kanazawa-application-support.jp/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    root /var/www/task.kanazawa-application-support.jp;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
EOF
              cat /tmp/nginx_fix.conf > /etc/nginx/conf.d/00-task.kanazawa-application-support.jp.conf'
              echo "Nginx config file updated with root directive"
            else
              echo "root directive already exists"
            fi
            
            echo "=== Verifying updated config ==="
            docker exec poster-mapping-deploy-frontend-1 cat /etc/nginx/conf.d/00-task.kanazawa-application-support.jp.conf | grep -A 5 "server_name\|root"
            
            echo "=== Checking default.conf ==="
            docker exec poster-mapping-deploy-frontend-1 ls -la /etc/nginx/conf.d/ | grep -E "default|00-"
            docker exec poster-mapping-deploy-frontend-1 cat /etc/nginx/conf.d/default.conf 2>/dev/null | grep -A 3 "server_name\|listen" || echo "default.conf not found or no server_name"
            
            echo "=== Disabling default.conf to prevent conflicts ==="
            # default.confを無効化（リネームして.disabledにする）
            docker exec poster-mapping-deploy-frontend-1 sh -c 'if [ -f /etc/nginx/conf.d/default.conf ] && [ ! -f /etc/nginx/conf.d/default.conf.disabled ]; then mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled; echo "default.conf disabled"; else echo "default.conf already disabled or not found"; fi'
            
            echo "=== Listing all Nginx config files after disabling default.conf ==="
            docker exec poster-mapping-deploy-frontend-1 ls -la /etc/nginx/conf.d/
            
            echo "=== Full Nginx configuration test ==="
            docker exec poster-mapping-deploy-frontend-1 nginx -T 2>&1 | head -100
            
            echo "=== Testing Nginx configuration ==="
            docker exec poster-mapping-deploy-frontend-1 nginx -t
            
            echo "=== Verifying task.kanazawa-application-support.jp server block ==="
            docker exec poster-mapping-deploy-frontend-1 nginx -T 2>&1 | grep -B 5 -A 15 "server_name task.kanazawa-application-support.jp" || echo "Warning: task.kanazawa-application-support.jp server block not found"
            
            echo "=== Checking root directory in Nginx config ==="
            docker exec poster-mapping-deploy-frontend-1 nginx -T 2>&1 | grep -A 20 "server_name task.kanazawa-application-support.jp" | grep -E "root|listen" || echo "root directive not found"
            
            echo "=== Finding all index.html files in /var/www ==="
            docker exec poster-mapping-deploy-frontend-1 find /var/www -name "index.html" -type f -exec ls -la {} \;
            
            echo "=== Checking which index.html is being served ==="
            docker exec poster-mapping-deploy-frontend-1 curl -s -k -H "Host: task.kanazawa-application-support.jp" https://localhost/ | grep -i "leaflet\|task.*map" | head -5 || echo "No leaflet or taskmap found in response"
            
            echo "=== Reloading Nginx ==="
            docker exec poster-mapping-deploy-frontend-1 nginx -s reload
            
            echo "=== Checking SSL certificate ==="
            docker exec poster-mapping-deploy-frontend-1 ls -la /etc/letsencrypt/live/task.kanazawa-application-support.jp/ 2>/dev/null || echo "SSL certificate directory not found"
            docker exec poster-mapping-deploy-frontend-1 openssl x509 -in /etc/letsencrypt/live/task.kanazawa-application-support.jp/fullchain.pem -noout -subject -dates 2>/dev/null || echo "SSL certificate file not found or invalid"
            
            echo "=== Testing actual HTTP response ==="
            # コンテナ内からlocalhostにリクエストを送って確認
            docker exec poster-mapping-deploy-frontend-1 curl -s -H "Host: task.kanazawa-application-support.jp" http://localhost/ | head -20 || echo "curl failed or no response"
            
            echo "=== Testing HTTPS response ==="
            # HTTPSで実際のコンテンツを確認
            docker exec poster-mapping-deploy-frontend-1 curl -s -k -H "Host: task.kanazawa-application-support.jp" https://localhost/ | head -30 || echo "HTTPS curl failed"
            
            echo "=== Checking which root directory is being served ==="
            docker exec poster-mapping-deploy-frontend-1 curl -s -H "Host: task.kanazawa-application-support.jp" http://localhost/index.html | head -10 || echo "Failed to fetch index.html"
            
            echo "=== Checking actual served content title ==="
            docker exec poster-mapping-deploy-frontend-1 curl -s -k -H "Host: task.kanazawa-application-support.jp" https://localhost/ | grep -i "<title>" || echo "Title not found"
            
            echo "=== Deployment completed successfully ==="
