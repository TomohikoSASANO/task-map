name: Deploy TaskMap

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:ci

      - name: Build application
        run: npm run build

      - name: Deploy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          # Copy full build output (including nested assets/).
          # Use strip_components to drop the leading "dist/" on the remote.
          source: "dist/**"
          target: "/var/www/task.kanazawa-application-support.jp"
          strip_components: 1
          rm: true

      - name: Copy Nginx config to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "nginx-task.conf"
          # scp-action's `target` is a directory on the remote.
          target: "/tmp"

      - name: Setup Docker container and Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e

            echo "Step 0: Detect frontend container"
            CONTAINER="$(docker ps --format '{{.Names}}' | grep -E '^poster-mapping-deploy-frontend' | head -n 1 || true)"
            if [ -z "$CONTAINER" ]; then
              echo "ERROR: poster-mapping-deploy-frontend container not found."
              echo "Currently running containers:"
              docker ps -a
              exit 1
            fi
            echo "Using container: $CONTAINER"

            echo "Step 1: Create directory in Docker container"
            docker exec "$CONTAINER" mkdir -p /var/www/task.kanazawa-application-support.jp

            echo "Step 2: Copy TaskMap files to Docker container"
            docker cp /var/www/task.kanazawa-application-support.jp/. "$CONTAINER":/var/www/task.kanazawa-application-support.jp/

            echo "Step 3: Copy Nginx config to Docker container"
            # Keep things simple and robust:
            # - Ensure nginx.conf isn't corrupted (previous runs may have injected literal "\n" or "}include ...")
            # - Place our vhost into /etc/nginx/conf.d where nginx.conf already includes it inside http { }.
            docker exec "$CONTAINER" sh -c 'set -e; CONF=/etc/nginx/nginx.conf; cp -f "$CONF" "$CONF.bak.taskmap.$(date +%s)" || true'
            # Repair common broken states from previous runs (no newline insertion needed):
            docker exec "$CONTAINER" sh -c 'set -e; CONF=/etc/nginx/nginx.conf; sed -i "s/;\\\\n/;/g" "$CONF"; sed -i "s/}include \\/etc\\/nginx\\/conf\\.d\\/\\*\\.conf;$/}/g" "$CONF"; sed -i "s/include \\/etc\\/nginx\\/taskmap\\.d\\/\\*\\.conf;\\\\n//g" "$CONF"; sed -i "s/include \\/etc\\/nginx\\/taskmap\\.d\\/\\*\\.conf;//g" "$CONF"'
            # Remove any previously injected taskmap.d directory (not used anymore)
            docker exec "$CONTAINER" sh -c 'rm -rf /etc/nginx/taskmap.d 2>/dev/null || true'
            docker cp /tmp/nginx-task.conf "$CONTAINER":/etc/nginx/conf.d/00-task.kanazawa-application-support.jp.conf

            echo "Step 4: Show nginx.conf include hints"
            docker exec "$CONTAINER" sh -c 'echo "--- /etc/nginx/nginx.conf (head) ---"; head -120 /etc/nginx/nginx.conf || true; echo "--- include lines ---"; grep -n "include" /etc/nginx/nginx.conf || true; echo "--- /etc/nginx/conf.d ---"; ls -la /etc/nginx/conf.d || true'

            echo "Step 5: Ensure TLS certificate exists (Let's Encrypt)"
            DOMAIN="task.kanazawa-application-support.jp"
            if ! docker exec "$CONTAINER" sh -c "test -f /etc/letsencrypt/live/$DOMAIN/fullchain.pem"; then
              echo "Certificate not found in container. Issuing via certbot..."

              # Prefer host certbot if available; fallback to a certbot container.
              if command -v certbot >/dev/null 2>&1; then
                WEBROOT="/opt/poster-mapping-deploy/certbot/www"
                if [ ! -d "$WEBROOT" ]; then
                  WEBROOT="/var/www/certbot"
                fi
                mkdir -p "$WEBROOT"
                certbot certonly --webroot -w "$WEBROOT" -d "$DOMAIN" --agree-tos --non-interactive --keep-until-expiring --email "admin@$DOMAIN"
              else
                CERTBOT_CONTAINER="$(docker ps --format '{{.Names}}' | grep -i certbot | head -n 1 || true)"
                if [ -z "$CERTBOT_CONTAINER" ]; then
                  echo "ERROR: certbot not found on host and no certbot container running."
                  exit 1
                fi
                # Most certbot images mount the webroot at /var/www/certbot
                docker exec "$CERTBOT_CONTAINER" sh -c 'mkdir -p /var/www/certbot'
                docker exec "$CERTBOT_CONTAINER" certbot certonly --webroot -w /var/www/certbot -d "$DOMAIN" --agree-tos --non-interactive --keep-until-expiring --email "admin@$DOMAIN"
              fi
            else
              echo "Certificate already exists."
            fi

            echo "Step 5.5: Show certificate details (debug)"
            docker exec "$CONTAINER" sh -c "ls -la /etc/letsencrypt/live/$DOMAIN || true"
            docker exec "$CONTAINER" sh -c "openssl x509 -in /etc/letsencrypt/live/$DOMAIN/fullchain.pem -noout -subject -issuer -startdate -enddate || true"

            echo "Step 6: Test Nginx configuration"
            docker exec "$CONTAINER" nginx -t

            echo "Step 7: Reload Nginx"
            docker exec "$CONTAINER" nginx -s reload

            echo "Step 8: Verify deployment"
            echo "Files in container:"
            docker exec "$CONTAINER" ls -la /var/www/task.kanazawa-application-support.jp/ | head -5

            echo "Index.html first 3 lines:"
            docker exec "$CONTAINER" head -3 /var/www/task.kanazawa-application-support.jp/index.html

            echo "Assets directory (should exist):"
            docker exec "$CONTAINER" sh -c 'if [ -d /var/www/task.kanazawa-application-support.jp/assets ]; then ls -la /var/www/task.kanazawa-application-support.jp/assets | head -5; else echo "MISSING: /var/www/task.kanazawa-application-support.jp/assets"; fi'

            echo "Index.html title (should be Task Map):"
            docker exec "$CONTAINER" sh -c 'grep -n "<title>" /var/www/task.kanazawa-application-support.jp/index.html | head -3 || true'

            echo "Nginx config check:"
            docker exec "$CONTAINER" nginx -T 2>&1 | grep -A 5 "server_name task.kanazawa-application-support.jp" | head -10

            echo "Deployment completed successfully!"

      - name: Verify public HTTPS certificate
        run: |
          set -e
          DOMAIN="task.kanazawa-application-support.jp"
          echo "Checking public TLS certificate for $DOMAIN ..."
          echo | openssl s_client -connect "$DOMAIN:443" -servername "$DOMAIN" -showcerts 2>/dev/null | openssl x509 -noout -subject -issuer -startdate -enddate
          echo "HTTP status/redirects:"
          curl -sS -I "https://$DOMAIN/" | head -20
